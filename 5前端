<template>
  <div id="app">
    <div class="container">
      <!-- 左侧边栏 -->
      <div class="sidebar">
        <button @click="startNewChat" class="new-chat-btn">+ 新聊天</button>

        <div class="history">
          <p class="history-title">您的聊天</p>
          <ul class="history-list">
            <li v-for="chat in chats" :key="chat.id" class="history-item" @click="selectChat(chat)">
              <p class="history-item-text">{{ chat.title }}</p>
            </li>
          </ul>
        </div>
      </div>

      <!-- 右侧聊天区域 -->
      <div class="chat-area">
        <!-- 会话记录（只滚动它自己） -->
        <div class="chat-history">
          <div class="chat-inner">
            <p v-if="isNewChat" class="welcome-message">
              老板好，我是邮箱秘书，您可以立即开始跟我聊天
            </p>

            <div
              v-for="(message, index) in messages"
              :key="index"
              class="message-row"
              :class="message.from"
            >
              <div class="bubble">
                {{ message.text }}
              </div>
            </div>
          </div>
        </div>

        <!-- 输入框（固定在右下，不随滚动变化） -->
        <div class="input-area">
          <div class="input-wrap">
            <textarea
              v-model="userMessage"
              class="input-box"
              placeholder="在这里输入消息（Enter 发送，Shift+Enter 换行）"
              @keydown.enter.exact.prevent="sendMessage"
              @keydown.enter.shift.stop
            ></textarea>

            <button @click="sendMessage" class="send-btn" aria-label="发送">
              <!-- 箭头图标（SVG） -->
              <svg viewBox="0 0 24 24" class="send-icon" aria-hidden="true">
                <path
                  d="M4 12l16-8-4 16-4-6-8-2z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      isNewChat: true,
      userMessage: '',
      messages: [],
      chats: [],            // [{id, title, messages:[]}, ...]
      nextChatId: 1,        // ✅ 给历史记录生成 id
      activeChatId: null    // ✅ 当前选中的历史会话
    };
  },
  methods: {
    // 本地兜底：如果标题接口失败，就用“最长的用户句子”截断（比第一句更靠谱）
    makeFallbackTitle(messages) {
      const userTexts = messages
        .filter(m => m.from === 'user')
        .map(m => (m.text || '').trim())
        .filter(Boolean);

      const best = userTexts.sort((a, b) => b.length - a.length)[0] || (messages[0]?.text || '新会话');
      const maxLen = 12;
      return best.length > maxLen ? best.slice(0, maxLen) + '…' : best;
    },

    // ✅ 点击左侧历史：右侧展示对应 messages
    selectChat(chat) {
      this.activeChatId = chat.id;
      this.messages = (chat.messages || []).map(m => ({ ...m })); // 拷贝一份到右侧
      this.userMessage = '';
      this.isNewChat = this.messages.length === 0;

      this.$nextTick(() => {
        const el = this.$el.querySelector('.chat-history');
        if (el) el.scrollTop = el.scrollHeight;
      });
    },

    // ✅ 点新聊天：先把当前对话保存成历史（带 messages），再清空
    async startNewChat() {
      if (this.messages.length) {
        let title = '';

        try {
          const resp = await fetch("http://localhost:3001/api/title", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messages: this.messages })
          });
          const data = await resp.json();
          if (resp.ok) title = data.title || '';
        } catch (e) {
          // 忽略，走兜底
        }

        if (!title) title = this.makeFallbackTitle(this.messages);

        const id = this.activeChatId || this.nextChatId++;
        const record = {
          id,
          title,
          messages: this.messages.map(m => ({ ...m }))
        };

        // 如果当前是某条历史会话，更新它；否则新增到左侧
        const idx = this.chats.findIndex(c => c.id === id);
        if (idx !== -1) {
          this.chats.splice(idx, 1, record);
        } else {
          this.chats.unshift(record);
        }
      }

      this.activeChatId = null;
      this.isNewChat = true;
      this.messages = [];
      this.userMessage = '';
    },

    async sendMessage() {
      if (!this.userMessage.trim()) return;

      // 1) 先把用户消息放进聊天记录
      const text = this.userMessage;
      this.messages.push({ text, from: 'user' });
      this.userMessage = '';
      this.isNewChat = false;

      // 2) 调后端：走 /api/agent（MCP 智能体），并把 tool/data 渲染成可读文本
      try {
        const resp = await fetch("http://localhost:3001/api/agent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: this.messages })
        });

        const data = await resp.json();

        if (!resp.ok) {
          this.messages.push({
            text: data?.error ? `后端错误：${data.error}` : "后端错误：请求失败",
            from: "agent"
          });
        } else {
          // 先显示 agent 的解释性回复
          if (data.reply) {
            this.messages.push({ text: data.reply || "（无回复）", from: "agent" });
          }

          // 如果有工具结果，把 data.data 渲染出来
          if (data.tool && data.data) {
            let rendered = "";

            // ✅ 收件箱列表（区分：今天 vs 时间范围）
            if ((data.tool === "mail.listTodayInbox" || data.tool === "mail.listInbox") && Array.isArray(data.data)) {
              // 优先用后端回传的 params 拼出范围提示（如果你后端没回 params，这段也不会报错）
              const rangeText =
                (data.params?.since || data.params?.before)
                  ? `（${data.params.since || "最早"} ~ ${data.params.before || "至今"}）`
                  : "";

              const header =
                data.tool === "mail.listTodayInbox"
                  ? "今天收件箱邮件如下：\n"
                  : `查询结果如下${rangeText}：\n`;

              if (data.data.length === 0) {
                rendered = data.tool === "mail.listTodayInbox"
                  ? "今天收件箱暂无邮件。"
                  : "该时间范围内收件箱暂无邮件。";
              } else {
                rendered =
                  header +
                  data.data
                    .map((m, i) => {
                      const date = m.date ? new Date(m.date).toLocaleString() : "";
                      return `${i + 1}. 【${m.subject || "无主题"}】\n   发件人：${m.from || "未知"}\n   时间：${date}\n   摘要：${m.snippet || ""}`;
                    })
                    .join("\n\n");
              }
            }

            // 发送邮件结果
            if (data.tool === "mail.send") {
              rendered = data.data?.ok
                ? `邮件已发送成功 ✅\nmessageId：${data.data.messageId || ""}`
                : `发送失败：${JSON.stringify(data.data)}`;
            }

            if (rendered) {
              this.messages.push({ text: rendered, from: "agent" });
            }
          }
        }
      } catch (e) {
        this.messages.push({
          text: "后端连接失败：请确认 backend 已启动（http://localhost:3001）",
          from: "agent"
        });
      }

      // ✅ 如果当前在查看某条历史会话，就把最新 messages 同步回该会话
      if (this.activeChatId) {
        const idx = this.chats.findIndex(c => c.id === this.activeChatId);
        if (idx !== -1) {
          this.chats[idx].messages = this.messages.map(m => ({ ...m }));
        }
      }

      // 3) 滚到底部
      this.$nextTick(() => {
        const el = this.$el.querySelector('.chat-history');
        if (el) el.scrollTop = el.scrollHeight;
      });
    }
  }
};
</script>



<style scoped>
/* 关键：让页面不整体滚动 */
#app,
.container {
  height: 100vh;
}
.container {
  display: flex;
  width: 100%;
  overflow: hidden; /* 防止整个页面一起滑动 */
  background-color: #e6ede9;
}

/* 左侧边栏：独立滚动 */
.sidebar {
  width: 300px;
  background-color: #e4f1eb;
  padding: 20px;
  display: flex;
  flex-direction: column;
  overflow-y: auto; /* 左侧只滚动自己 */
}

.new-chat-btn {
  background-color: #4c7854;
  border: none;
  padding: 12px;
  width: 100%;
  color: white;
  font-size: 16px;
  cursor: pointer;
  border-radius: 12px;
  margin-bottom: 16px;
}

.history-title {
  font-weight: 700;
  margin: 6px 0 10px;
}

.history-list {
  padding: 0;
  margin: 0;
  list-style: none;
}

.history-item {
  padding: 10px 10px;
  border-radius: 10px;
  cursor: pointer;
}
.history-item:hover {
  background: rgba(255, 255, 255, 0.55);
}
.history-item-text {
  margin: 0;
}

/* 右侧聊天区域：不滚动整个区域，只有 chat-history 滚 */
.chat-area {
  flex: 1;
  position: relative;
  background-color: #ffffff;
  overflow: hidden;
  padding: 20px 20px 0;
}

/* 聊天展示框：独立滚动 */
.chat-history {
  height: calc(100vh - 20px - 110px); /* 顶部padding(20) + 输入区高度(约110) */
  overflow-y: auto;
  padding: 18px 0 18px;
}

/* 中间内容区域（你要的“只占中间位置”） */
.chat-inner {
  width: min(760px, 100%);
  margin: 0 auto;
  padding: 0 6px;
}

/* 欢迎语 */
.welcome-message {
  font-size: 16px;
  color: #555;
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(0, 0, 0, 0.06);
  border-radius: 16px;
  padding: 14px 16px;
  margin: 6px 0 18px;
}

/* 每条消息一行：根据 user/agent 控制左右 */
.message-row {
  display: flex;
  margin: 10px 0;
}

.message-row.user {
  justify-content: flex-end;
}
.message-row.agent {
  justify-content: flex-start;
}

/* 气泡：类似 ChatGPT/微信，圆角包住文字 */
.bubble {
  max-width: 70%;
  padding: 12px 14px;
  border-radius: 18px;
  line-height: 1.5;
  font-size: 14px;
  word-break: break-word;
  box-shadow: 0 2px 10px rgba(0,0,0,0.06);
}

/* 不同角色不同底色（你也可以换成更 ChatGPT 的灰色系） */
.message-row.user .bubble {
  background: #dff2ff;
  border: 1px solid rgba(0,0,0,0.06);
}
.message-row.agent .bubble {
  background: #ffffff;
  border: 1px solid rgba(0,0,0,0.06);
}

/* 输入区：固定在右侧区域底部，不随聊天滚动 */
.input-area {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 18px;
  display: flex;
  justify-content: center;
  pointer-events: none; /* 让外层不挡住滚动，内部再开启 */
}

/* 输入框容器：按钮在内部靠右 */
.input-wrap {
  width: min(760px, 100%);
  position: relative;
  padding: 0 6px;
  pointer-events: auto;
}

/* 白色输入框：更高、更窄；placeholder 贴顶部 */
.input-box {
  width: 100%;
  height: 92px;                 /* 高一点（你想更高就改这里） */
  padding: 12px 56px 12px 14px; /* 右侧留按钮空间 */
  border: 1px solid rgba(0,0,0,0.15);
  border-radius: 18px;
  font-size: 14px;
  background: #fff;
  box-sizing: border-box;
  outline: none;

  resize: none;                 /* 不要拖拽改变尺寸 */
  line-height: 1.5;
  vertical-align: top;
}

/* 让 placeholder 更贴顶部、更像你要的 */
.input-box::placeholder {
  color: rgba(0,0,0,0.45);
}

/* 发送按钮：明显、带箭头，放在白色输入框内部 */
.send-btn {
  position: absolute;
  right: 18px;
  bottom: 14px;

  width: 44px;
  height: 44px;
  border-radius: 14px;

  border: none;
  cursor: pointer;

  background: #4c7854;          /* 明显按钮 */
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

.send-btn:active {
  transform: translateY(1px);
}

.send-icon {
  width: 22px;
  height: 22px;
  fill: #fff;
}
</style>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden; /* 禁止页面整体滚动 */
}
</style>
